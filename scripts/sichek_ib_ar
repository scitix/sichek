#!/bin/bash
set -e

OUTDIR=/tmp/ibdiagnet_report
LOGFILE=$OUTDIR/ibdiagnet2.log

# æ£€æŸ¥ ibdiagnet æ˜¯å¦å­˜åœ¨
if ! command -v ibdiagnet >/dev/null 2>&1; then
    echo "âŒ æœªæ‰¾åˆ° ibdiagnetï¼Œè¯·å…ˆå®‰è£… ibutils2 / MLNX_OFED åŒ…"
    exit 1
fi

# æ‰§è¡Œ ibdiagnet
ibdiagnet -r -o $OUTDIR > /dev/null 2>&1

# ç¡®è®¤æ—¥å¿—æ–‡ä»¶å­˜åœ¨
if [ ! -f "$LOGFILE" ]; then
    echo "âŒ æœªæ‰¾åˆ° $LOGFILE, è¯·æ£€æŸ¥ ibdiagnet æ˜¯å¦æ‰§è¡ŒæˆåŠŸ"
    exit 1
fi

# æå–æ€»äº¤æ¢æœºæ•°
total_switches=$(grep "IB Switches" "$LOGFILE" | awk '{print $4}')

# æå–å¯ç”¨ AR çš„äº¤æ¢æœºæ•°
ar_enabled=$(grep "Adaptive Routing is enabled on" "$LOGFILE" | awk '{print $6}' | tr -dc '0-9')

# è¾“å‡ºç»“æœ
if [ -n "$total_switches" ] && [ -n "$ar_enabled" ]; then
    rate=$(awk "BEGIN {printf \"%.2f\", ($ar_enabled/$total_switches)*100}")
    if [ "$rate" != "100.00" ]; then
        echo "ğŸš¨ ä¸¥é‡è­¦å‘Š: AR å¯ç”¨äº¤æ¢æœºæ•°: $ar_enabled / æ€»äº¤æ¢æœºæ•°: $total_switches (å¯ç”¨ç‡: $rate%)"
    else
        echo "âœ… AR å¯ç”¨äº¤æ¢æœºæ•°: $ar_enabled / æ€»äº¤æ¢æœºæ•°: $total_switches (å¯ç”¨ç‡: $rate%)"
    fi
else
    echo "âš ï¸ æœªèƒ½è§£æå‡ºäº¤æ¢æœºä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ $LOGFILE å†…å®¹"
fi