#!/usr/bin/env bash
set -euo pipefail

# é»˜è®¤æœŸæœ›å€¼ï¼ˆå¯é€šè¿‡å‚æ•°è¦†ç›–ï¼‰
EXPECTED_GPU=8
EXPECTED_IB=32

# å‚æ•°è§£æ
while [[ $# -gt 0 ]]; do
  case "$1" in
    --gpu)
      EXPECTED_GPU="$2"
      shift 2
      ;;
    --ib)
      EXPECTED_IB="$2"
      shift 2
      ;;
    *)
      echo "æœªçŸ¥å‚æ•°: $1"
      echo "ç”¨æ³•: $0 [--gpu <æœŸæœ›GPUæ•°>] [--ib <æœŸæœ›IBæ•°>]"
      exit 1
      ;;
  esac
done

# æ£€æŸ¥ jq æ˜¯å¦å®‰è£…
if ! command -v jq &>/dev/null; then
  echo "âŒ éœ€è¦å®‰è£… jq æ‰èƒ½è¿è¡Œæ­¤è„šæœ¬"
  echo "   Ubuntu/Debian: sudo apt-get install -y jq"
  echo "   CentOS/RHEL:   sudo yum install -y jq"
  exit 1
fi

GPU_RES="nvidia.com/gpu"
IB_RES="rdma/hca_shared_devices_all"

echo "ğŸ” æ£€æŸ¥èŠ‚ç‚¹ GPU(cap=${EXPECTED_GPU}) å’Œ IB(cap=${EXPECTED_IB}) capacity/allocatable æ˜¯å¦åŒ¹é…..."
echo

printf "%-30s | %-10s %-10s | %-10s %-10s\n" "NODE" "GPU_CAP" "GPU_ALLOCATABLE" "IB_CAP" "IB_ALLOCATABLE"
echo "-----------------------------------------------------------------------------------"

unmatched_node=0
for node in $(kubectl get nodes -o json | jq -r '.items[] | select(.status.allocatable["nvidia.com/gpu"]) | .metadata.name'); do
  # è·å– GPU
  gpu_capacity=$(kubectl get node "$node" -o json | jq -r --arg res "$GPU_RES" '.status.capacity[$res] // 0')
  gpu_allocatable=$(kubectl get node "$node" -o json | jq -r --arg res "$GPU_RES" '.status.allocatable[$res] // 0')

  # è·å– IB
  ib_capacity=$(kubectl get node "$node" -o json | jq -r --arg res "$IB_RES" '.status.capacity[$res] // 0')
  ib_allocatable=$(kubectl get node "$node" -o json | jq -r --arg res "$IB_RES" '.status.allocatable[$res] // 0')

  # æ£€æŸ¥æ˜¯å¦ä¸åŒ¹é…
  if [[ "$gpu_capacity" != "$EXPECTED_GPU" ]] || [[ "$gpu_allocatable" != "$EXPECTED_GPU" ]] \
     || [[ "$ib_capacity" != "$EXPECTED_IB" ]] || [[ "$ib_allocatable" != "$EXPECTED_IB" ]]; then
    printf "%-30s | %-10s %-10s | %-10s %-10s\n" \
      "$node" "$gpu_capacity" "$gpu_allocatable" "$ib_capacity" "$ib_allocatable"
    unmatched_node=$((unmatched_node + 1))
  fi
done

echo "-----------------------------------------------------------------------------------"
if [[ $unmatched_node -eq 0 ]]; then
  echo "âœ… æ‰€æœ‰èŠ‚ç‚¹çš„ GPU å’Œ IB capacity/allocatable éƒ½ç­‰äºæœŸæœ›å€¼ã€‚"
else
  echo "âŒ æ‰¾åˆ° $unmatched_node ä¸ªèŠ‚ç‚¹çš„ GPU æˆ– IB capacity/allocatable ä¸ç­‰äºæœŸæœ›å€¼ã€‚"
fi
echo "-----------------------------------------------------------------------------------"