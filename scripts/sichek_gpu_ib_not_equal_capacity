#!/usr/bin/env bash
set -euo pipefail

# Default expected values (can be overridden by parameters)
EXPECTED_GPU=8
EXPECTED_IB=32

# Parse parameters
while [[ $# -gt 0 ]]; do
  case "$1" in
    --gpu)
      EXPECTED_GPU="$2"
      shift 2
      ;;
    --ib)
      EXPECTED_IB="$2"
      shift 2
      ;;
    *)
      echo "Unknown parameter: $1"
      echo "Usage: $0 [--gpu <expected GPU count>] [--ib <expected IB count>]"
      exit 1
      ;;
  esac
done

# Check if jq is installed
if ! command -v jq &>/dev/null; then
  echo "‚ùå jq needs to be installed to run this script"
  echo "   Ubuntu/Debian: sudo apt-get install -y jq"
  echo "   CentOS/RHEL:   sudo yum install -y jq"
  exit 1
fi

GPU_RES="nvidia.com/gpu"
IB_RES="rdma/hca_shared_devices_all"

echo "üîç Checking if node GPU (cap=${EXPECTED_GPU}) and IB (cap=${EXPECTED_IB}) capacity/allocatable match..."
echo

printf "%-30s | %-10s %-10s | %-10s %-10s\n" "NODE" "GPU_CAP" "GPU_ALLOCATABLE" "IB_CAP" "IB_ALLOCATABLE"
echo "-----------------------------------------------------------------------------------"

unmatched_node=0
for node in $(kubectl get nodes -o json | jq -r '.items[] | select(.status.allocatable["nvidia.com/gpu"]) | .metadata.name'); do
  # Get GPU
  gpu_capacity=$(kubectl get node "$node" -o json | jq -r --arg res "$GPU_RES" '.status.capacity[$res] // 0')
  gpu_allocatable=$(kubectl get node "$node" -o json | jq -r --arg res "$GPU_RES" '.status.allocatable[$res] // 0')

  # Get IB
  ib_capacity=$(kubectl get node "$node" -o json | jq -r --arg res "$IB_RES" '.status.capacity[$res] // 0')
  ib_allocatable=$(kubectl get node "$node" -o json | jq -r --arg res "$IB_RES" '.status.allocatable[$res] // 0')

  # Check if not matching
  if [[ "$gpu_capacity" != "$EXPECTED_GPU" ]] || [[ "$gpu_allocatable" != "$EXPECTED_GPU" ]] \
     || [[ "$ib_capacity" != "$EXPECTED_IB" ]] || [[ "$ib_allocatable" != "$EXPECTED_IB" ]]; then
    printf "%-30s | %-10s %-10s | %-10s %-10s\n" \
      "$node" "$gpu_capacity" "$gpu_allocatable" "$ib_capacity" "$ib_allocatable"
    unmatched_node=$((unmatched_node + 1))
  fi
done

echo "-----------------------------------------------------------------------------------"
if [[ $unmatched_node -eq 0 ]]; then
  echo "‚úÖ All nodes have GPU and IB capacity/allocatable equal to expected values."
else
  echo "‚ùå Found $unmatched_node nodes where GPU or IB capacity/allocatable does not equal expected values."
fi
echo "-----------------------------------------------------------------------------------"