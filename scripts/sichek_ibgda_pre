#!/usr/bin/env bash
echo "=== IBGDA Prerequisites Health Check ==="
##########################################################################
##  ref. https://docs.nvidia.com/nvshmem/api/using.html#using-the-nvshmem-gpu-initiated-communications-transport
##  The IBGDA transport has the following prerequisites:
##
##  Only Mellanox HCAs and NICs.
##  Mellanox OFED 5.0 or newer.
##  nvidia.ko >= 510.40.3
##  Either nvidia_peermem >= 510.40.3 or nv_peer_mem >= 1.3
##########################################################################

# table print function
print_row() {
    local item="$1"
    local status="$2"
    local detail="$3"
    printf "| %-20s | %-3s | %-60s |\n" "$item" "$status" "$detail"
}

# version compare (using sort -V, return 0 if former >= latter)
version_ge() {
    [ "$(printf '%s\n%s' "$2" "$1" | sort -V | head -n1)" = "$2" ]
}

fail_flag=0

echo "+----------------------+-----+--------------------------------------------------------------+"
printf "| %-20s | %-3s | %-60s |\n" "Check Item" "Status" "Detail"
echo "+----------------------+-----+--------------------------------------------------------------+"

# 1. Mellanox NIC
nics=$(lspci | grep -i mell)
if [[ -n "$nics" ]]; then
    nic_count=$(echo "$nics" | wc -l)
    good_count=0
    while IFS= read -r nic; do
        [[ -z "$nic" ]] && continue
        print_row "Mellanox HCA/NIC" "✅" "$nic"
        ((good_count++))
    done <<< "$nics"
    if [[ $good_count -eq $nic_count ]]; then
        print_row "Mellanox HCA/NIC Summary" "✅" "Total: $nic_count, Good: $good_count"
    else
        print_row "Mellanox HCA/NIC Summary" "❌" "Total: $nic_count, Good: $good_count"
        fail_flag=1
    fi
else
    print_row "Mellanox HCA/NIC" "❌" "No Mellanox NIC found"
    fail_flag=1
fi

# 2. MLNX OFED version
if command -v ofed_info >/dev/null 2>&1; then
    ofed=$(ofed_info -s 2>/dev/null)
    ver=$(echo "$ofed" | grep -oE '[0-9]+\.[0-9]+' | head -n1)
    if version_ge "$ver" "5.0"; then
        print_row "MLNX OFED" "✅" "$ofed"
    else
        print_row "MLNX OFED" "❌" "$ofed (need >=5.0)"
        fail_flag=1
    fi
else
    print_row "MLNX OFED" "❌" "ofed_info not installed (maybe using inbox driver)"
    fail_flag=1
fi

# 3. NVIDIA driver
nvidia_ver=$(modinfo nvidia 2>/dev/null | grep ^version: | awk '{print $2}')
if [[ -n "$nvidia_ver" ]]; then
    if version_ge "$nvidia_ver" "510.40.3"; then
        print_row "NVIDIA Driver" "✅" "$nvidia_ver"
    else
        print_row "NVIDIA Driver" "❌" "$nvidia_ver (need >=510.40.3)"
        fail_flag=1
    fi
else
    print_row "NVIDIA Driver" "❌" "nvidia.ko module not found"
    fail_flag=1
fi

# 4. PeerMem module
peermem_mod=$(lsmod | grep -E 'nvidia_peermem|nv_peer_mem' | awk '{print $1}' | head -n1)
if [[ -n "$peermem_mod" ]]; then
    peermem_ver=$(modinfo $peermem_mod | grep ^version: | awk '{print $2}')
    if [[ "$peermem_mod" == "nvidia_peermem" ]]; then
        if version_ge "$peermem_ver" "510.40.3"; then
            print_row "PeerMem ($peermem_mod)" "✅" "$peermem_ver"
        else
            print_row "PeerMem ($peermem_mod)" "❌" "$peermem_ver (need >=510.40.3)"
            fail_flag=1
        fi
    elif [[ "$peermem_mod" == "nv_peer_mem" ]]; then
        if version_ge "$peermem_ver" "1.3"; then
            print_row "PeerMem ($peermem_mod)" "✅" "$peermem_ver"
        else
            print_row "PeerMem ($peermem_mod)" "❌" "$peermem_ver (need >=1.3)"
            fail_flag=1
        fi
    fi
else
    print_row "PeerMem Module" "❌" "nvidia_peermem / nv_peer_mem not loaded"
    fail_flag=1
fi

echo "+----------------------+-----+--------------------------------------------------------------+"

# Summary and exit
if [[ $fail_flag -eq 0 ]]; then
    echo "✅ All IBGDA prerequisites are satisfied"
    exit 0
else
    echo "❌ Some IBGDA prerequisites are not satisfied"
    exit 1
fi