#!/usr/bin/env bash
set -euo pipefail

# é»˜è®¤æœ€å°å‰©ä½™æ•°é‡ï¼ˆå¯é€šè¿‡å‚æ•°è¦†ç›–ï¼‰
MIN_FREE_GPU=8
MIN_FREE_IB=32

# å‚æ•°è§£æ
while [[ $# -gt 0 ]]; do
  case "$1" in
    --gpu)
      MIN_FREE_GPU="$2"
      shift 2
      ;;
    --ib)
      MIN_FREE_IB="$2"
      shift 2
      ;;
    *)
      echo "æœªçŸ¥å‚æ•°: $1"
      echo "ç”¨æ³•: $0 [--gpu <æœ€å¤§å‰©ä½™GPUæ•°>] [--ib <æœ€å¤§å‰©ä½™IBæ•°>]"
      exit 1
      ;;
  esac
done

# æ£€æŸ¥ jq æ˜¯å¦å®‰è£…
if ! command -v jq &>/dev/null; then
  echo "âŒ éœ€è¦å®‰è£… jq æ‰èƒ½è¿è¡Œæ­¤è„šæœ¬"
  echo "   Ubuntu/Debian: sudo apt-get install -y jq"
  echo "   CentOS/RHEL:   sudo yum install -y jq"
  echo "   MacOS:         brew install jq"
  exit 1
fi

GPU_RES="nvidia.com/gpu"
IB_RES="rdma/hca_shared_devices_all"

echo "ğŸ” æŸ¥æ‰¾ GPUå‰©ä½™(allocatable - allocated) < ${MIN_FREE_GPU} æˆ–è€… IBå‰©ä½™ < ${MIN_FREE_IB} çš„èŠ‚ç‚¹..."
echo

printf "%-30s | %-10s %-10s %-10s | %-10s %-10s %-10s\n" \
  "NODE" "GPU_CAP" "GPU_ALLOC" "GPU_FREE" "IB_CAP" "IB_ALLOC" "IB_FREE"
echo "------------------------------------------------------------------------------------------------------"

matched_node=0
for node in $(kubectl get nodes -o json | jq -r '.items[] | select(.status.allocatable["nvidia.com/gpu"]) | .metadata.name'); do
  # GPUå®¹é‡ & å¯åˆ†é…
  gpu_capacity=$(kubectl get node "$node" -o json | jq -r --arg res "$GPU_RES" '.status.capacity[$res] // 0')
  gpu_allocatable=$(kubectl get node "$node" -o json | jq -r --arg res "$GPU_RES" '.status.allocatable[$res] // 0')
  # GPUå·²åˆ†é…
  gpu_allocated=$(kubectl get pods -A --field-selector spec.nodeName="$node",status.phase=Running \
    -o json | jq "[.items[].spec.containers[].resources.requests[\"$GPU_RES\"] | (tonumber? // 0)] | add // 0")
  gpu_free=$((gpu_allocatable - gpu_allocated))

  # IBå®¹é‡ & å¯åˆ†é…
  ib_capacity=$(kubectl get node "$node" -o json | jq -r --arg res "$IB_RES" '.status.capacity[$res] // 0')
  ib_allocatable=$(kubectl get node "$node" -o json | jq -r --arg res "$IB_RES" '.status.allocatable[$res] // 0')
  # IBå·²åˆ†é…
  ib_allocated=$(kubectl get pods -A --field-selector spec.nodeName="$node",status.phase=Running \
    -o json | jq "[.items[].spec.containers[].resources.requests[\"$IB_RES\"] | (tonumber? // 0)] | add // 0")
  ib_free=$((ib_allocatable - ib_allocated))

  # æ¡ä»¶ï¼šå‰©ä½™èµ„æº â‰¥ æŒ‡å®šå€¼
  if [[ "$gpu_free" -lt "$MIN_FREE_GPU" || "$ib_free" -lt "$MIN_FREE_IB" ]]; then
    printf "%-30s | %-10s %-10s %-10s | %-10s %-10s %-10s\n" \
      "$node" "$gpu_capacity" "$gpu_allocatable" "$gpu_free" \
      "$ib_capacity" "$ib_allocatable" "$ib_free"
    matched_node=$((matched_node + 1))
  fi
done

echo "------------------------------------------------------------------------------------------------------"
if [[ $matched_node -eq 0 ]]; then
  echo "âŒ æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ã€‚"
else
  echo "âœ… æ‰¾åˆ° $matched_node ä¸ªèŠ‚ç‚¹ç¬¦åˆæ¡ä»¶ã€‚"
fi
echo "------------------------------------------------------------------------------------------------------"

