#!/usr/bin/env bash
set -euo pipefail

echo "üîç Checking if NVIDIA driver parameters (StreamMemOPs / PeerMappingOverride) are enabled..."

# key params to check
PARAMS=$(cat /proc/driver/nvidia/params | grep -E 'StreamMemOPs|PeerMappingOverride' || true)

if [[ -z "$PARAMS" ]]; then
    echo "‚ùå Not found related params, maybe driver version not supported or path is wrong"
    exit 1
fi

echo "$PARAMS"

# check if all params are enabled
OK=1
if ! echo "$PARAMS" | grep -q "EnableStreamMemOPs.*1"; then
    echo "‚ùå EnableStreamMemOPs is not enabled"
    OK=0
fi
if ! echo "$PARAMS" | grep -q "PeerMappingOverride=1"; then
    echo "‚ùå PeerMappingOverride is not enabled"
    OK=0
fi

if [[ $OK -eq 1 ]]; then
    echo "‚úÖ IBGDA is enabled"
    exit 0
else
    echo "‚ö†Ô∏è IBGDA is not enabled, please check /etc/modprobe.d/nvidia.conf and restart system"
    exit 1
fi