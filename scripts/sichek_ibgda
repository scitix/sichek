#!/usr/bin/env bash
set -euo pipefail

echo "ğŸ” æ£€æŸ¥ NVIDIA é©±åŠ¨å‚æ•° (StreamMemOPs / PeerMappingOverride) æ˜¯å¦å¼€å¯..."

# key params to check
PARAMS=$(cat /proc/driver/nvidia/params | grep -E 'StreamMemOPs|PeerMappingOverride' || true)

if [[ -z "$PARAMS" ]]; then
    echo "âŒ Not found related params, maybe driver version not supported or path is wrong"
    exit 1
fi

echo "$PARAMS"

# check if all params are enabled
OK=1
if ! echo "$PARAMS" | grep -q "EnableStreamMemOPs.*1"; then
    echo "âŒ EnableStreamMemOPs is not enabled"
    OK=0
fi
if ! echo "$PARAMS" | grep -q "PeerMappingOverride=1"; then
    echo "âŒ PeerMappingOverride is not enabled"
    OK=0
fi

if [[ $OK -eq 1 ]]; then
    echo "âœ… Driver Hack params are enabled, can support GPUâ†’NIC direct connection"
    exit 0
else
    echo "âš ï¸ Some params are not enabled, please check /etc/modprobe.d/nvidia.conf and restart system"
    exit 1
fi