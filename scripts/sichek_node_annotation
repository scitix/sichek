#!/bin/bash

check_node_sichek_status() {
  local ready_only=false

  # Parse parameters
  while [[ $# -gt 0 ]]; do
    case "$1" in
      ready-only)
        ready_only=true
        shift
        ;;
      *)
        shift
        ;;
    esac
  done

  kubectl get nodes -o json | jq -r '
    .items[] |
    {
      name: .metadata.name,
      unschedulable: (.spec.unschedulable // false),
      sichek: (.metadata.annotations["scitix.ai/sichek"] // ""),
      ready: (
        .status.conditions[] | select(.type == "Ready") | .status
      )
    } |
    select(.sichek | test("err")) |
    "\(.name)|\(.unschedulable)|\(.ready)|\(.sichek)"
  ' | while IFS='|' read -r name unschedulable ready sichek; do

    # Skip if --ready-only is set and node is not Ready
    if $ready_only && [[ "$ready" != "True" || "$unschedulable" == "true" ]]; then
      continue
    fi

    # Status label
    if [[ "$ready" != "True" ]]; then
      ready_label=$(printf "\033[1;31mNotReady\033[0m")   # ðŸ”´
    elif [[ "$unschedulable" == "true" ]]; then
      ready_label=$(printf "\033[1;33mCordoned\033[0m")   # ðŸŸ¡
    else
      ready_label=$(printf "\033[1;32mReady\033[0m")      # ðŸŸ¢
    fi

    printf "%s [%s] -> %s\n" "$name" "$ready_label" "$sichek"
  done
}

check_node_sichek_status "$@"